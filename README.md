# Age Rating Service

Сервис, который автоматически проставляет возрастной рейтинг для сценариев сериалов/фильмов (6+, 12+, 16+, 18+).

На вход он получает сценарий (`.pdf` или `.docx`), разбивает его на сцены, анализирует текст и возвращает:

- общий возрастной рейтинг сценария;
- по каким категориям есть проблемы:
  - насилие (`violence`)
  - эротика (`erotica`)
  - ненормативная лексика (`profanity`)
  - вещества (алкоголь/наркотики) (`substances`)
  - страшное/хоррор (`scary`)
- список проблемных сцен с фрагментами текста и подсвеченными словами;
- рекомендации, что можно переписать, чтобы снизить рейтинг.

---

## Как это работает (по-человечески)

1. **Разбор файла**
   - Сервис принимает файл (`.pdf` или `.docx`) через ручку `/analyze_file`.
   - Внутри он вытаскивает из него текст и режет сценарий на сцены.

2. **Лексический анализ (словари / регулярки)**
   - В модуле `ml/lexicons.py` лежат списки паттернов (регулярных выражений) под каждую категорию:
     - насилие, кровь, оружие;
     - поцелуи / секс / эротика;
     - мат и жёсткие оскорбления;
     - алкоголь / наркотики;
     - хоррор, кладбище, смерть, трупы и т.п.
   - Для каждой сцены мы пробегаемся по этим паттернам и определяем:
     - есть ли нарушения;
     - насколько они жёсткие (none / mild / moderate / severe).

3. **Перевод нарушений в возраст**
   - В `LexicalAnalyzer.scene_min_age` зашиты простые правила:
     - обычные диалоги без жести → 6+
     - лёгкий флер романтики / шампанское → 12+
     - драки, кровь, мат → 16+
     - тяжёлое насилие, жёсткая эротика, наркотики → 18+
   - Для каждой сцены получается минимальный возраст: 6 / 12 / 16 / 18.

4. **Нейросеть (BERT-классификатор)**
   - Отдельная модель (`AgeClassifier` + `ml/train_age.py`) обучается на размеченных сценах.
   - Она читает текст сцены целиком и предсказывает один из четырёх классов: 6 / 12 / 16 / 18.
   - В бою сервис аккуратно комбинирует:
     - **лексический возраст** (жёсткие правила по словам),
     - **возраст от нейросети** (контекст, стиль, намёки).

   Логика комбинации такая:
   - если NN говорит не хуже, чем лексика → остаёмся на лексике;
   - если NN хочет поднять возраст, но сцена по лексике детская (6+) → максимум поднимаем до 12+;
   - если лексика говорит 12+, NN может поднять максимум до 16+;
   - если сцена и так 16+ → NN может поднять до 18+.

   Это сделано чтобы нейросеть не могла внезапно сделать 18+ из нормального детского диалога.

5. **Агрегация по всему сценарию**
   - Складываем результаты по сценам:
     - `script_age` — максимальный возраст по лексике;
     - `nn_script_age` — максимальный возраст по предсказаниям нейросети;
     - итоговый `rating_int` — комбинация этих двух.
   - Строим:
     - `per_category` — какая максимальная жёсткость по каждой категории, в скольких сценах встречается.
     - `problem_scenes` — сцены, где:
       - есть нарушения,
       - или у сцены возраст выше 6+.
   - В проблемных сценах:
     - есть текстовый сниппет,
     - список «issues» (категория, severity),
     - подсвеченные фразы/слова (для фронта — чтобы показать редактору, что именно лучше поправить).
